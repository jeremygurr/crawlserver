#!/bin/bash

source common

v="$1"
crawlBin="crawl-$v"

make="nice make -j2 NOASSERTS=True prefix=${web} GAME=\"${crawlBin}.new\" USE_DGAMELAUNCH=y WEBTILES=y"

unset success
while true; do
	mkdir -p $web/bin || break
	mkdir -p $web/rcs-$v/running || break
	mkdir -p $web/rcs-$v/ttyrecs || break
	touch $web/bin/${crawlBin} $web/bin/${crawlBin}.old
	cd $web/bin || break

	cd $code || break
	$make debug-lite || break
	cd $web/bin || break

	while true; do
		rm ${crawlBin}.old && break
		echo "Failed, but will retry in a min..."
		sleep 60
	done
	cd $code || break

	$make debug-lite install || break

	cd $web/bin || break
	mv ${crawlBin} ${crawlBin}.old || break
	mv ${crawlBin}.new ${crawlBin} || break

	success=true
    break
done

if [ "$success" ]; then
	echo "Successful."
else
	echo "Failed!"
	exit 1
fi

