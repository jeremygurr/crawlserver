#!/bin/bash

source common 

make="nice make -j2 NOASSERTS=True prefix=${web} GAME=\"crawl\" USE_DGAMELAUNCH=y WEBTILES=y"

unset success
while true; do
	mkdir -p $web/bin || break
	touch $web/bin/crawl $web/bin/crawl.old
	cd $web/bin || break

	cd $code || break
	STRIP=echo $make debug-lite || break
	cd $web/bin || break

	while true; do
		rm crawl.old && break
		echo "Failed, but will retry in a min..."
		sleep 60
	done
	mv crawl crawl.old || break
	cd $code || break

	STRIP=echo $make install || break

	success=true
    break
done

if [ "$success" ]; then
	echo "Successful."
else
	echo "Failed!"
	exit 1
fi

